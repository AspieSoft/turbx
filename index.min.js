const fs=require("fs"),{join}=require("path"),crypto=require("crypto"),memoryCache=require("@aspiesoft/obj-memory-cache"),multiTaskQueue=require("@aspiesoft/multi-task-queue"),common=require("./common.min"),{escapeHTML,escapeHTMLArgs,compileMD,compileJS,compileCSS,sleep,randomToken,clean,toTimeMillis,asyncReplace,getOpt}=common,{tagFunctions,addTagFunction,runTagFunction}=require("./functions.min"),localCache=memoryCache.newCache({watch:__dirname}),taskQueue=multiTaskQueue(10);let ExpressApp;const ROOT=require.main.filename?clean(require.main.filename.toString()).replace(/[\\\/][^\\\/]+[\\\/]?$/,""):require.main.path?clean(require.main.path.toString()):process.cwd&&process.cwd()?clean(process.cwd()):clean(join(__dirname).toString().replace(/[\/\\]node_modules[\/\\][^\\\/]+[\\\/]?$/,"")),OPTS={},emptyRes=JSON.stringify({html:"",scripts:[],args:[]});function getTemplateFile(e,t,r,s=!1){taskQueue(e,(async function(){const n=localCache.get("template_file_cache:"+e);if(n||""===n)return void r(n);let a=join(OPTS.root,e+"."+OPTS.ext);if(a===OPTS.root||!a.startsWith(OPTS.root))return localCache.set("template_file_cache:"+e,"",{expire:t.cache||OPTS.cache||"2h"}),void r(emptyRes);if(s&&!fs.existsSync(a)){let s=t.components||OPTS.components;if(s&&s!==OPTS.root&&s.startsWith(OPTS.root)&&(a=join(s,e+"."+OPTS.ext),a===OPTS.root||!a.startsWith(OPTS.root)))return localCache.set("template_file_cache:"+e,"",{expire:t.cache||OPTS.cache||"2h"}),void r(emptyRes)}if(!fs.existsSync(a)&&(a=join(OPTS.root,e,"index."+OPTS.ext),a===OPTS.root||!a.startsWith(OPTS.root)))return localCache.set("template_file_cache:"+e,"",{expire:t.cache||OPTS.cache||"2h"}),void r(emptyRes);if(!fs.existsSync(a))return localCache.set("template_file_cache:"+e,"",{expire:t.cache||OPTS.cache||"2h"}),void r(emptyRes);let i=!1;for(fs.readFile(a,((s,n)=>{if(s)return localCache.set("template_file_cache:"+e,"",{expire:t.cache||OPTS.cache||"2h",listen:[a]}),i=!0,void r(emptyRes);n=function(e){e=encodeEncoding(e);const t=[];function r(e,r){return e.replace(/%!([0-9]+)!%/g,((e,s)=>{if(!1===r)return t[s].str;if(!0===r){let e=t[s].str;return e.match(/^[0-9]+(\.[0-9]+|)$/)?e:t[s].tag+e+t[s].tag}return t[s].tag+t[s].str+t[s].tag})).replace(/%!([oc])!%/g,((e,t)=>"o"===t?"%!":"c"===t?"!%":""))}e=e.replace(/(['"`])((?:\\[\\'"`]|.)*?)\1|<!--.*?-->|\/\*.*?\*\/|(?:\/\/|#!).*?\r?\n/gs,((e,r,s)=>r&&s?`%!${t.push({tag:r,str:s})-1}!%`:""));const s=[];e=e.replace(/<(script|js|style|css|less|markdown|md|text|txt)(.*?)>(.*?)<\/\1>/gis,((e,n,a,i)=>{if("md"===(n=n.toLowerCase())?n="markdown":"txt"===n?n="text":"js"===n?n="script":"css"!==n&&"less"!==n||(n="style"),a=r(a),"script"===n){let e=[];return i=i.replace(/%!([0-9]+)!%/g,((r,s)=>`%!${e.push(t[s])-1}!%`)),i=compileJS(i),`<!_script ${s.push({tag:n,args:a,content:i,strings:e})-1}/>`}return i=r(i),"text"===n?i=escapeHTML(i):"markdown"===n?i=compileMD(i):"script"===n?i=compileJS(i):"style"===n&&(i=compileCSS(i)),`<!_script ${s.push({tag:n,args:a,content:i})-1}/>`}));const n=[];let a=0;return e=e.replace(/<(\/|)([\w_\-\.$!:]+)\s*(.*?)\s*(\/|)>/gs,((e,t,s,i,o)=>{if(i=i.split(/\s+/),!s.match(/^_|[A-Z]/))return""!==(i=r(i=i.sort(((e,t)=>{if("string"!=typeof e||"string"!=typeof t)return 0;let r=e.substring(0,e.indexOf("=")),s=t.substring(0,t.indexOf("="));return r>s?1:r<s?-1:0})).join(" "))).trim()&&(i=" "+i),`<${t}${s}${i}${o}>`;if(""===t){let e;if(s.match(/^_(el(if|se)|if)$/)){e=[];for(let t=0;t<i.length;t++){if(i[t].match(/^([!<>]?=|{{{?.*?}}}?)$/)){e.push(i[t]);continue}let s=i[t].split(/([!<>]?=|[&|<>])/);e.push(...s.map((e=>r(e,!0))).filter((e=>e&&""!==e.trim())))}e.map((e=>e.match(/^(["'`])[0-9]+(?:\.[0-9]+|)\1$/)?Number(e.replace(/^(["'`])([0-9]+(?:\.[0-9]+|))\1$/,"$2")):e))}else{e={};let t=0;for(let s=0;s<i.length;s++){if(""===i[s])continue;if(i[s]&&"="===i[s+1]&&i[s+2]){e[r(i[s],!1)]=r(i[s+2],!0),s+=2;continue}let n=i[s].split("=");if(1===n.length)e[t]=r(n[0],!0),t++;else if(2===n.length)e[r(n[0],!1)]=r(n[1],!0);else if(n.length>2){let t=n[n.length-1];for(let s=0;s<n.length-1;s++)e[r(n[s],!1)]=r(n[t],!0)}}const s=Object.keys(e);for(let t=0;t<s.length;t++)e[s[t]].match(/^(["'`])[0-9]+(?:\.[0-9]+|)\1$/)&&(e[s[t]]=Number(e[s[t]].replace(/^(["'`])([0-9]+(?:\.[0-9]+|))\1$/,"$2")))}let t=`<${s}:${a} ${n.push(e)-1}${o}>`;return""===o&&a++,t}return a--,`</${s}:${a}>`})),e=decodeEncoding(e=r(e)),JSON.stringify({html:e,scripts:s,args:n,strings:t})}(n.toString()),localCache.set("template_file_cache:"+e,n,{expire:t.cache||OPTS.cache||"2h",listen:[a]}),i=!0,r(n)}));!i;)await sleep(10)}))}function engine(e,t,r){e=clean(e),t=clean(t),OPTS.ext||(OPTS.ext=t.settings["view engine"]||(e.includes(".")?e.substring(e.lastIndexOf(".")).replace(".",""):"xhtml")),OPTS.root||(OPTS.root=t.settings.views||t.settings.view||(require.main.filename||process.argv[1]||__dirname).replace(/([\\\/]node_modules[\\\/].*?|[\\\/][^\\\/]*)$/,"/views")),e.includes(".")&&(e=e.substring(0,e.lastIndexOf("."))),e=e.replace(OPTS.root,"").replace(/^[\\\/]+/,""),t.settings.filename=e,getTemplateFile(e,t,(async e=>{if(e===emptyRes)return r(new Error("View Not Found!"),"");if(OPTS.before){let r=OPTS.before(e,t);void 0!==r&&(e=r)}if("function"==typeof t.before){let r=t.before(e,t);void 0!==r&&(e=r)}if(e=await compile(e,t,!0),"function"==typeof t.after){let r=t.after(e,t);void 0!==r&&(e=r)}if(OPTS.after){let r=OPTS.after(e,t);void 0!==r&&(e=r)}return r(null,e)}))}function encodeEncoding(e){return e.replace(/%!|!%/g,(e=>"%!"===e?"%!o!%":"!%"===e?"%!c!%":""))}function decodeEncoding(e){return e.replace(/%!([oc])!%/g,((e,t)=>"o"===t?"%!":"c"===t?"!%":""))}async function compile(e,t,r=!1){if(OPTS.opts&&(t={...OPTS.opts,...t}),"string"==typeof e&&(e=JSON.parse(e)),r){let r=t.template||OPTS.template;if("string"==typeof r){let s=!1;for(getTemplateFile(r,t,(async r=>{""!==(r=await compile(r,t)).trim()?(r.match(/{{{?body}}}?|<body(\s+.*?|)\/>/is)?e.html=r.replace(/{{{?body}}}?|<body(\s+.*?|)\/>/is,e.html):r.match(/<(main|\/header)(\s+.*?|)>/is)?e.html=r.replace(/<(main|\/header)(\s+.*?|)>/is,(t=>t+"\n"+e.html)):r.match(/<(footer|\/body)(\s+.*?|)>/is)?e.html=r.replace(/<(footer|\/body)(\s+.*?|)>/is,(t=>e.html+"\n"+t)):e.html=r+e.html,s=!0):s=!0}));!s;)await sleep(10)}}return await runFunctions(e,t),r&&function(){let r;if(!1===function(e){let t=e.secure||OPTS.secure;if("object"!=typeof t)return!0;let r=Object.keys(t)[0];return"string"!=typeof r||!1!==t[r]||"7LUl6NM1epycs7tWgXC/FuPl2NDhUL59uFzT+1B9Fgg="!==crypto.createHash("sha256").update(r).digest("base64")}(t))r={...t},delete r.secure,delete r.settings,delete r._locals,delete r.cache,delete r.template,delete r.view,delete r.views;else{if(!t.public)return;r={...t.public}}const s=`<script>\n        ;const OPTS = ${JSON.stringify(r)};\n      <\/script>`;e.html.match(/<\/head>/)?e.html=e.html.replace(/<\/head>/,`\n        ${s}\n        </head>\n        `):e.html.match(/<body(\s+.*?|)>/)?e.html=e.html.replace(/<body(\s+.*?|)>/,`\n        <body$1>\n        ${s}\n        `):e.html.match(/<!_script(\s+.*?|)>/)?e.html=e.html.replace(/!_<script(\s+.*?|)>/,`\n        ${s}\n        <!_script$1>\n        `):e.html=s+e.html}(),e.html=e.html.replace(/<(\/|)([\w_\-\.$!:]+):[0-9]+\s+(.*?)(\/|)>/g,((t,r,s,n,a)=>{if(s.startsWith("_")||s.startsWith("!_"))return"";if(""===r){let t=[],r=e.args[n],i=Object.keys(r);for(let e=0;e<i.length;e++)Number(i[e])||0===Number(i[e])?t.push(r[i[e]]):t.push(i[e]+"="+r[i[e]]);if(!Array.isArray(t)){const e=Object.keys(t),r=[];for(let s=0;s<e.length;s++)r.push(e[s]+"="+t[e[s]]);t=r}t=t.sort(((e,t)=>{if("string"!=typeof e||"string"!=typeof t)return 0;let r=e.substring(0,e.indexOf("=")),s=t.substring(0,t.indexOf("="));return r>s?1:r<s?-1:0})).join(" "),""!==t.trim()&&(t=" "+t);let o=`<${s}${t}>`;return""!==a&&(o+=`</${s}>`),o}return`</${s}>`})),e.html=e.html.replace(/<!_script\s+([0-9]+)\/>/gs,((r,s)=>{let n=e.scripts[s],a=n.content;return"script"===n.tag&&(a=a.replace(/(?<![\w_$]+)OPTS\.((?:\[.*?\]|[\w_$\.])+)/g,((e,r)=>{let s=getOpt(t,r,!1);return s instanceof RegExp?s.toString():"object"==typeof s?JSON.stringify(s):"string"==typeof s?"'"+s.replace(/'/g,"\\'")+"'":void 0!==s?null===s?null:s.toString():void 0})).replace(/%!([0-9]+)!%/g,((e,t)=>n.strings[t].tag+n.strings[t].str+n.strings[t].tag)).replace(/%!([oc])!%/g,((e,t)=>"o"===t?"%!":"c"===t?"!%":""))),"script"===n.tag||"style"===n.tag?`<${n.tag}${n.args}>${a}</${n.tag}>`:`<div type="${n.tag}"${n.args}>${a}</div>`})),e.html}async function runFunctions(e,t,r=0){return e.html=await asyncReplace(e.html,new RegExp(`<_([\\w_\\-\\.$!:]+):${r}(\\s+[0-9]+|)>(.*?)</_\\1:${r}>`,"gs"),(async(s,n,a,i)=>{let o=e.args[a.trim()];n=n.toLowerCase().replace(/[-_]/g,"");const c=tagFunctions[n];if(!c)return"";if(Array.isArray(c)){let s;for(let n=0;n<c.length;n++){let a=c[n];"string"==typeof a&&(a=tagFunctions[a]),"function"==typeof a&&(s=await c(o,i,t,r+1,{scripts:e.scripts,args:e.args}))}if(["string","number","boolean"].includes(typeof s)&&!Number.isNaN(s))return await runFunctions({html:s.toString(),scripts:e.scripts,args:e.args},t,r+1);if(Array.isArray(s)){let t="";for(let n=0;n<s.length;n++)t+=await runFunctions({html:s[n].html.toString(),scripts:e.scripts,args:e.args},s[n].opts,r+1);return t}return""}if("string"==typeof c&&(c=tagFunctions[c]),"function"==typeof c){let s=await c(o,i,t,r+1,{scripts:e.scripts,args:e.args});if(["string","number","boolean"].includes(typeof s)&&!Number.isNaN(s))return await runFunctions({html:s.toString(),scripts:e.scripts,args:e.args},t,r+1);if(Array.isArray(s)){let t="";for(let n=0;n<s.length;n++)t+=await runFunctions({html:s[n].html.toString(),scripts:e.scripts,args:e.args},s[n].opts,r+1);return t}}return""})),e.html=await asyncReplace(e.html,new RegExp(`<([A-Z][\\w_\\-\\.$!:]+):${r}(\\s+[0-9]+|)>(.*?)</\\1:${r}>`,"gs"),(async(s,n,a,i)=>{let o,c=e.args[a.trim()];n=n.toLowerCase(),i=await runFunctions({html:i,scripts:e.scripts,args:e.args},t,r+1);const l={...t,...c};for(getTemplateFile(n,l,(async e=>{e=JSON.parse(e);let t=[];e.html=encodeEncoding(e.html).replace(/<body\/>|{{{?body}}}?/gis,(e=>`%!${t.push(e)-1}!%`));let r=await compile(e,l);o=decodeEncoding(r.replace(/%!([0-9]+)!%/g,((e,r)=>t[r].replace(/<body\/>|{{{body}}}/is,encodeEncoding(i)).replace(/{{body}}/is,encodeEncoding(escapeHTML(i))))))}),!0);void 0===o;)await sleep(10);return o})),e.html=await asyncReplace(e.html,new RegExp(`<([A-Z][\\w_\\-\\.$!:]+):${r}(\\s+[0-9]+|)/>`,"gs"),(async(r,s,n)=>{let a,i=e.args[n.trim()];s=s.toLowerCase();const o={...t,...i};for(getTemplateFile(s,o,(async e=>{let t=await compile(e,o);a=t.replace(/<body\/>|{{{?body}}}?/is,"")}),!0);void 0===a;)await sleep(10);return a})),e.html=await asyncReplace(e.html,new RegExp(`<_([\\w_\\-\\.$!:]+):${r}(\\s+[0-9]+|)/>`,"gs"),(async(s,n,a)=>{let i=e.args[a.trim()];n=n.toLowerCase().replace(/[-_]/g,"");let o=tagFunctions[n];if(!o)return"";if(Array.isArray(o)){let s;for(let n=0;n<o.length;n++){let a=o[n];"string"==typeof a&&(a=tagFunctions[a]),"function"==typeof a&&(s=await o(i,null,t,r+1,{scripts:e.scripts,args:e.args}))}if(["string","number","boolean"].includes(typeof s)&&!Number.isNaN(s))return await runFunctions({html:s.toString(),scripts:e.scripts,args:e.args},t,r+1);if(Array.isArray(s)){let t="";for(let n=0;n<s.length;n++)t+=await runFunctions({html:s[n].html.toString(),scripts:e.scripts,args:e.args},s[n].opts,r+1);return t}return""}if("string"==typeof o&&(o=tagFunctions[o]),"function"==typeof o){let s=await o(i,null,t,r+1,{scripts:e.scripts,args:e.args});if(["string","number","boolean"].includes(typeof s)&&!Number.isNaN(s))return await runFunctions({html:s.toString(),scripts:e.scripts,args:e.args},t,r+1);if(Array.isArray(s)){let t="";for(let n=0;n<s.length;n++)t+=await runFunctions({html:s[n].html.toString(),scripts:e.scripts,args:e.args},s[n].opts,r+1);return t}}return""})),e.html=e.html.replace(/({{{?)(.*?)}}}?/gs,((e,r,s)=>{if(2===(s=s.split("=")).length){let e="",r=s[1].replace(/(["'`]|)(.*?)\1/gs,((t,r,s)=>(e=r,s))),n=getOpt(t,r);return""===s[0].trim()?r+"="+e+escapeHTMLArgs(n)+e:s[0].trim()+"="+e+escapeHTMLArgs(n)+e}let n=getOpt(t,s[0].trim());return"{{"===r&&(n=escapeHTML(n)),n})),e.html}function expressFallbackPages(e,t){"object"==typeof e&&([e,t]=[t,e]),"function"!=typeof e&&(e=ExpressApp),"function"==typeof e&&("object"!=typeof t&&(t={}),e.use(((e,r,s)=>{engine(clean(e.url),{settings:{env:process.env.NODE_ENV||"development"},...t},((e,t)=>{!e&&t&&"string"==typeof t?r.status(200).send(t).end():s()}))})),e.use(((e,t)=>{let r=join(OPTS.root,"404."+OPTS.ext);fs.existsSync(r)?t.render(404):t.status(404).send("<h1>Error 404</h1><h2>Page Not Found</h2>").end()})))}module.exports=function(){const e=function(e={views:"views",components:"components",ext:"xhtml",template:void 0,cache:"2h",lazyCache:"12h",timeout:"30s",before:void 0,after:void 0,static:"/",opts:{}},t){return"function"!=typeof e&&"object"!=typeof t||([e,t]=[t,e]),function(e){let t=e.before,r=e.after,s=(e=clean(e)).views||"views";OPTS.ext=(e.ext||"xhtml").replace(/[^\w_\-]/g,"");let n=s.replace(/[^\w_\-\\\/\.@$#!]/g,"");if(n.startsWith(ROOT)||(n=join(ROOT,n)),OPTS.root=n,e.components){let t=e.components.replace(/[^\w_\-\\\/\.@$#!]/g,"");t.startsWith(ROOT)||(t=join(ROOT,t)),OPTS.components=t,localCache.watch([n,t])}else localCache.watch([n]);let a=(e.template||"").replace(/[^\w_\-\\\/\.@$#!]/g,"");a&&""!==a.trim()&&(OPTS.template=a),OPTS.cache=e.cache||"2h",OPTS.lazyCache=e.lazyCache||"12h",OPTS.timeout=e.timeout||"30s","function"==typeof t&&(OPTS.before=t),"function"==typeof r&&(OPTS.after=r),"string"==typeof e.static?OPTS.static=e.static:OPTS.static="/","object"==typeof e.opts?OPTS.opts=e.opts:OPTS.opts={},void 0!==e.secure?OPTS.secure=e.secure:OPTS.secure=!0}("object"==typeof e?e:{}),"function"==typeof t&&(function(e){e.use("/lazyload/:component/:id",(async(e,t,r)=>{let s="template_lazyload_cache:"+clean(e.params.component)+clean(e.params.id),n=localCache.get(s),a=toTimeMillis(OPTS.timeout||"30s")/100;for(;!n&&a-- >0;)await sleep(100),n=localCache.get(s);n?"string"==typeof n?(t.status(200).send(n).end(),localCache.delete(s)):(t.status(404).send("<h1>Error 404</h1><h2>Component Not Found</h2>").end(),localCache.delete(s)):getTemplateFile(clean(e.params.component),{},(async e=>{const r=await compile(e,{});"string"==typeof r?t.status(200).send(r).end():t.status(404).send("<h1>Error 404</h1><h2>Component Not Found</h2>").end()}))})),e.use("/lazyloadpage/:id/:page",(async(e,t,r)=>{let s=Number(clean(e.params.page));if(!s&&0!==s)return void t.status(400).send("<h1>Error 400</h1><h2>Page (last url param) Must Be A Valid Number</h2>").end();let n="template_lazyload_page_cache:"+clean(e.params.id),a=localCache.get(n),i=toTimeMillis(OPTS.timeout||"30s")/100;for(;!a&&i-- >0;)await sleep(100),a=localCache.get(n);a?Array.isArray(a)?(t.status(200).send(a[s]).end(),localCache.delete(n)):(t.status(404).send("<h1>Error 404</h1><h2>Component Not Found</h2>").end(),localCache.delete(n)):t.status(404).send("<h1>Error 404</h1><h2>Component Not Found</h2>").end()}))}(t),ExpressApp=t),engine};return e.renderPages=expressFallbackPages,e.function={...common,add:addTagFunction,run:runTagFunction},e}();