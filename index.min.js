const fs=require("fs"),{join}=require("path"),crypto=require("crypto"),memoryCache=require("@aspiesoft/obj-memory-cache"),multiTaskQueue=require("@aspiesoft/multi-task-queue"),common=require("./common.min"),{escapeHTML,escapeHTMLArgs,compileMD,compileJS,compileCSS,sleep,randomToken,clean,toTimeMillis,asyncReplace,getOpt}=common,{tagFunctions,addTagFunction,runTagFunction}=require("./functions.min"),localCache=memoryCache.newCache({watch:__dirname}),taskQueue=multiTaskQueue(10);let ExpressApp;const ROOT=require.main.filename?clean(require.main.filename.toString()).replace(/[\\\/][^\\\/]+[\\\/]?$/,""):require.main.path?clean(require.main.path.toString()):process.cwd&&process.cwd()?clean(process.cwd()):clean(join(__dirname).toString().replace(/[\/\\]node_modules[\/\\][^\\\/]+[\\\/]?$/,"")),OPTS={},emptyRes=JSON.stringify({html:"",scripts:[],args:[]});function getTemplateFile(e,t,s,r=!1){taskQueue(e,(async function(){const n=localCache.get("template_file_cache:"+e);if(n||""===n)return void s(n);let a=join(OPTS.root,e+"."+OPTS.ext);if(a===OPTS.root||!a.startsWith(OPTS.root))return localCache.set("template_file_cache:"+e,"",{expire:t.cache||OPTS.cache||"2h"}),void s(emptyRes);if(r&&!fs.existsSync(a)){let r=t.components||OPTS.components;if(r&&r!==OPTS.root&&r.startsWith(OPTS.root)&&(a=join(r,e+"."+OPTS.ext),a===OPTS.root||!a.startsWith(OPTS.root)))return localCache.set("template_file_cache:"+e,"",{expire:t.cache||OPTS.cache||"2h"}),void s(emptyRes)}if(!fs.existsSync(a)&&(a=join(OPTS.root,e,"index."+OPTS.ext),a===OPTS.root||!a.startsWith(OPTS.root)))return localCache.set("template_file_cache:"+e,"",{expire:t.cache||OPTS.cache||"2h"}),void s(emptyRes);if(!fs.existsSync(a))return localCache.set("template_file_cache:"+e,"",{expire:t.cache||OPTS.cache||"2h"}),void s(emptyRes);let i=!1;for(fs.readFile(a,((r,n)=>{if(r)return localCache.set("template_file_cache:"+e,"",{expire:t.cache||OPTS.cache||"2h",listen:[a]}),i=!0,void s(emptyRes);n=function(e){e=e.replace(/%!|!%/g,(e=>"%!"===e?"%!o!%":"!%"===e?"%!c!%":""));const t=[];function s(e,s){return e.replace(/%!([0-9]+)!%/g,((e,r)=>{if(!1===s)return t[r].str;if(!0===s){let e=t[r].str;return e.match(/^-?[0-9]+(\.[0-9]+|)$/)?e:t[r].tag+e+t[r].tag}return t[r].tag+t[r].str+t[r].tag})).replace(/%!([oc])!%/g,((e,t)=>"o"===t?"%!":"c"===t?"!%":""))}e=e.replace(/(['"`])((?:\\[\\'"`]|.)*?)\1|<!--.*?-->|\/\*.*?\*\/|(?<!:)(?:\/\/|#!).*?\r?\n/gs,((e,s,r)=>s&&r?`%!${t.push({tag:s,str:r})-1}!%`:""));const r=[];e=e.replace(/<(script|js|style|css|less|markdown|md|text|txt)(.*?)>(.*?)<\/\1>/gis,((e,n,a,i)=>{if("md"===(n=n.toLowerCase())?n="markdown":"txt"===n?n="text":"js"===n?n="script":"css"!==n&&"less"!==n||(n="style"),a=s(a),"script"===n){let e=[];return i=i.replace(/%!([0-9]+)!%/g,((s,r)=>`%!${e.push(t[r])-1}!%`)),i=compileJS(i),`<!_script ${r.push({tag:n,args:a,content:i,strings:e})-1}/>`}return i=s(i),"text"===n?i=escapeHTML(i):"markdown"===n?i=compileMD(i):"script"===n?i=compileJS(i):"style"===n&&(i=compileCSS(i)),`<!_script ${r.push({tag:n,args:a,content:i})-1}/>`}));const n=[];let a=0;return e=e.replace(/<(\/|)([\w_\-\.$!:]+)\s*(.*?)\s*(\/|)>/gs,((e,t,r,i,c)=>{if(i=i.split(/\s+/),!r.match(/^_|[A-Z]/))return""!==(i=s(i=i.sort(((e,t)=>{if("string"!=typeof e||"string"!=typeof t)return 0;let s=e.substring(0,e.indexOf("=")),r=t.substring(0,t.indexOf("="));return s>r?1:s<r?-1:0})).join(" "))).trim()&&(i=" "+i),`<${t}${r}${i}${c}>`;if(""===t){let e;if(r.match(/^_(el(if|se)|if)$/)){e=[];for(let t=0;t<i.length;t++){if(i[t].match(/^([!<>]?=|{{{?.*?}}}?)$/)){e.push(i[t]);continue}let r=i[t].split(/([!<>]?=|[&|<>])/);e.push(...r.map((e=>s(e,!0))).filter((e=>e&&""!==e.trim())))}e.map((e=>e.match(/^(["'`])[0-9]+(?:\.[0-9]+|)\1$/)?Number(e.replace(/^(["'`])([0-9]+(?:\.[0-9]+|))\1$/,"$2")):e))}else{e={};let t=0;for(let r=0;r<i.length;r++){if(""===i[r])continue;if(i[r]&&"="===i[r+1]&&i[r+2]){e[s(i[r],!1)]=s(i[r+2],!0),r+=2;continue}let n=i[r].split("=");if(1===n.length)e[t]=s(n[0],!0),t++;else if(2===n.length)e[s(n[0],!1)]=s(n[1],!0);else if(n.length>2){let t=n[n.length-1];for(let r=0;r<n.length-1;r++)e[s(n[r],!1)]=s(n[t],!0)}}const r=Object.keys(e);for(let t=0;t<r.length;t++)e[r[t]].match(/^(["'`])[0-9]+(?:\.[0-9]+|)\1$/)&&(e[r[t]]=Number(e[r[t]].replace(/^(["'`])([0-9]+(?:\.[0-9]+|))\1$/,"$2")))}let t=`<${r}:${a} ${n.push(e)-1}${c}>`;return""===c&&a++,t}return a--,`</${r}:${a}>`})),i=e=s(e),e=i.replace(/%!([oc])!%/g,((e,t)=>"o"===t?"%!":"c"===t?"!%":"")),JSON.stringify({html:e,scripts:r,args:n,strings:t});var i}(n.toString()),localCache.set("template_file_cache:"+e,n,{expire:t.cache||OPTS.cache||"2h",listen:[a]}),i=!0,s(n)}));!i;)await sleep(10)}))}function engine(e,t,s){e=clean(e),t=clean(t),OPTS.ext||(OPTS.ext=t.settings["view engine"]||(e.includes(".")?e.substring(e.lastIndexOf(".")).replace(".",""):"xhtml")),OPTS.root||(OPTS.root=t.settings.views||t.settings.view||(require.main.filename||process.argv[1]||__dirname).replace(/([\\\/]node_modules[\\\/].*?|[\\\/][^\\\/]*)$/,"/views")),e.includes(".")&&(e=e.substring(0,e.lastIndexOf("."))),e=e.replace(OPTS.root,"").replace(/^[\\\/]+/,""),t.settings.filename=e,getTemplateFile(e,t,(async e=>{if(e===emptyRes)return s(new Error("View Not Found!"),"");if(OPTS.before){let s=OPTS.before(e,t);void 0!==s&&(e=s)}if("function"==typeof t.before){let s=t.before(e,t);void 0!==s&&(e=s)}if(e=await compile(e,t,!0),"function"==typeof t.after){let s=t.after(e,t);void 0!==s&&(e=s)}if(OPTS.after){let s=OPTS.after(e,t);void 0!==s&&(e=s)}return s(null,e)}))}async function compile(e,t,s=!1){if(OPTS.opts&&(t={...OPTS.opts,...t}),"string"==typeof e&&(e=JSON.parse(e)),s){let s=t.template||OPTS.template;if("string"==typeof s){let r=!1;for(getTemplateFile(s,t,(async s=>{""!==(s=await compile(s,t)).trim()?(s.match(/{{{?body}}}?|<body(\s+.*?|)\/>/is)?e.html=s.replace(/{{{?body}}}?|<body(\s+.*?|)\/>/is,e.html):s.match(/<(main|\/header)(\s+.*?|)>/is)?e.html=s.replace(/<(main|\/header)(\s+.*?|)>/is,(t=>t+"\n"+e.html)):s.match(/<(footer|\/body)(\s+.*?|)>/is)?e.html=s.replace(/<(footer|\/body)(\s+.*?|)>/is,(t=>e.html+"\n"+t)):e.html=s+e.html,r=!0):r=!0}));!r;)await sleep(10)}}return await runFunctions(e,t),s&&function(){let s;if(!1===function(e){let t=e.secure||OPTS.secure;if("object"!=typeof t)return!0;let s=Object.keys(t)[0];return"string"!=typeof s||!1!==t[s]||"7LUl6NM1epycs7tWgXC/FuPl2NDhUL59uFzT+1B9Fgg="!==crypto.createHash("sha256").update(s).digest("base64")}(t))s={...t},delete s.secure,delete s.settings,delete s._locals,delete s.cache,delete s.template,delete s.view,delete s.views;else{if(!t.public)return;s={...t.public}}const r=`<script>\n        ;const OPTS = ${JSON.stringify(s)};\n      <\/script>`;e.html.match(/<\/head>/)?e.html=e.html.replace(/<\/head>/,`\n        ${r}\n        </head>\n        `):e.html.match(/<body(\s+.*?|)>/)?e.html=e.html.replace(/<body(\s+.*?|)>/,`\n        <body$1>\n        ${r}\n        `):e.html.match(/<!_script(\s+.*?|)>/)?e.html=e.html.replace(/!_<script(\s+.*?|)>/,`\n        ${r}\n        <!_script$1>\n        `):e.html=r+e.html}(),e.html=e.html.replace(/<(\/|)([\w_\-\.$!:]+):[0-9]+\s+(.*?)(\/|)>/g,((t,s,r,n,a)=>{if(r.startsWith("_")||r.startsWith("!_"))return"";if(""===s){let t=[],s=e.args[n],i=Object.keys(s);for(let e=0;e<i.length;e++)Number(i[e])||0===Number(i[e])?t.push(s[i[e]]):t.push(i[e]+"="+s[i[e]]);if(!Array.isArray(t)){const e=Object.keys(t),s=[];for(let r=0;r<e.length;r++)s.push(e[r]+"="+t[e[r]]);t=s}t=t.sort(((e,t)=>{if("string"!=typeof e||"string"!=typeof t)return 0;let s=e.substring(0,e.indexOf("=")),r=t.substring(0,t.indexOf("="));return s>r?1:s<r?-1:0})).join(" "),""!==t.trim()&&(t=" "+t);let c=`<${r}${t}>`;return""!==a&&(c+=`</${r}>`),c}return`</${r}>`})),e.html=e.html.replace(/<!_script\s+([0-9]+)\/>/gs,((s,r)=>{let n=e.scripts[r],a=n.content;return"script"===n.tag&&(a=a.replace(/(?<![\w_$]+)OPTS\.((?:\[.*?\]|[\w_$\.])+)/g,((e,s)=>{let r=getOpt(t,s,!1);return r instanceof RegExp?r.toString():"object"==typeof r?JSON.stringify(r):"string"==typeof r?"'"+r.replace(/'/g,"\\'")+"'":void 0!==r?null===r?null:r.toString():void 0})).replace(/%!([0-9]+)!%/g,((e,t)=>n.strings[t].tag+n.strings[t].str+n.strings[t].tag)).replace(/%!([oc])!%/g,((e,t)=>"o"===t?"%!":"c"===t?"!%":""))),"script"===n.tag||"style"===n.tag?`<${n.tag}${n.args}>${a}</${n.tag}>`:`<div type="${n.tag}"${n.args}>${a}</div>`})),e.html}async function runFunctions(e,t,s=0){return e.html=await asyncReplace(e.html,new RegExp(`<_([\\w_\\-\\.$!:]+):${s}(\\s+[0-9]+|)>(.*?)</_\\1:${s}>`,"gs"),(async(r,n,a,i)=>{let c=e.args[a.trim()];n=n.toLowerCase().replace(/[-_]/g,"");const o=tagFunctions[n];if(!o)return"";if(Array.isArray(o)){let r;for(let n=0;n<o.length;n++){let a=o[n];"string"==typeof a&&(a=tagFunctions[a]),"function"==typeof a&&(r=await o(c,i,t,s+1,{scripts:e.scripts,args:e.args}))}if(["string","number","boolean"].includes(typeof r)&&!Number.isNaN(r))return await runFunctions({html:r.toString(),scripts:e.scripts,args:e.args},t,s+1);if(Array.isArray(r)){let t="";for(let n=0;n<r.length;n++)t+=await runFunctions({html:r[n].html.toString(),scripts:e.scripts,args:e.args},r[n].opts,s+1);return t}return""}if("string"==typeof o&&(o=tagFunctions[o]),"function"==typeof o){let r=await o(c,i,t,s+1,{scripts:e.scripts,args:e.args});if(["string","number","boolean"].includes(typeof r)&&!Number.isNaN(r))return await runFunctions({html:r.toString(),scripts:e.scripts,args:e.args},t,s+1);if(Array.isArray(r)){let t="";for(let n=0;n<r.length;n++)t+=await runFunctions({html:r[n].html.toString(),scripts:e.scripts,args:e.args},r[n].opts,s+1);return t}}return""})),e.html=await asyncReplace(e.html,new RegExp(`<([A-Z][\\w_\\-\\.$!:]+):${s}(\\s+[0-9]+|)>(.*?)</\\1:${s}>`,"gs"),(async(r,n,a,i)=>{let c,o=e.args[a.trim()];n=n.toLowerCase(),i=await runFunctions({html:i,scripts:e.scripts,args:e.args},t,s+1);const l={...t,...o,body:i};for(getTemplateFile(n,l,(async e=>{e=JSON.parse(e),c=await compile(e,l)}),!0);void 0===c;)await sleep(10);return c})),e.html=await asyncReplace(e.html,new RegExp(`<([A-Z][\\w_\\-\\.$!:]+):${s}(\\s+[0-9]+|)/>`,"gs"),(async(s,r,n)=>{let a,i=e.args[n.trim()];r=r.toLowerCase();const c={...t,...i};for(getTemplateFile(r,c,(async e=>{let t=await compile(e,c);a=t.replace(/<body\/>|{{{?body}}}?/is,"")}),!0);void 0===a;)await sleep(10);return a})),e.html=await asyncReplace(e.html,new RegExp(`<_([\\w_\\-\\.$!:]+):${s}(\\s+[0-9]+|)/>`,"gs"),(async(r,n,a)=>{let i=e.args[a.trim()];n=n.toLowerCase().replace(/[-_]/g,"");let c=tagFunctions[n];if(!c)return"";if(Array.isArray(c)){let r;for(let n=0;n<c.length;n++){let a=c[n];"string"==typeof a&&(a=tagFunctions[a]),"function"==typeof a&&(r=await c(i,null,t,s+1,{scripts:e.scripts,args:e.args}))}if(["string","number","boolean"].includes(typeof r)&&!Number.isNaN(r))return await runFunctions({html:r.toString(),scripts:e.scripts,args:e.args},t,s+1);if(Array.isArray(r)){let t="";for(let n=0;n<r.length;n++)t+=await runFunctions({html:r[n].html.toString(),scripts:e.scripts,args:e.args},r[n].opts,s+1);return t}return""}if("string"==typeof c&&(c=tagFunctions[c]),"function"==typeof c){let r=await c(i,null,t,s+1,{scripts:e.scripts,args:e.args});if(["string","number","boolean"].includes(typeof r)&&!Number.isNaN(r))return await runFunctions({html:r.toString(),scripts:e.scripts,args:e.args},t,s+1);if(Array.isArray(r)){let t="";for(let n=0;n<r.length;n++)t+=await runFunctions({html:r[n].html.toString(),scripts:e.scripts,args:e.args},r[n].opts,s+1);return t}}return""})),e.html=e.html.replace(/({{{?)(.*?)(}}}?)/gs,((e,s,r)=>{if(2===(r=r.split("=")).length){let e="",s=r[1].replace(/(["'`]|)(.*?)\1/gs,((t,s,r)=>(e=s,r))),n=getOpt(t,s);return""===r[0].trim()?(s=s.split("|")[0].split(/\.|(\[.*?\])/).filter((e=>e&&!e.match(/^[0-9]+|\[.*\]$/))),s=s[s.length-1],s+"="+e+escapeHTMLArgs(n)+e):r[0].trim()+"="+e+escapeHTMLArgs(n)+e}let n=getOpt(t,r[0].trim());return"{{"!==s&&"}}"!==esc2||(n=escapeHTML(n)),n})),e.html}function expressFallbackPages(e,t){"object"==typeof e&&([e,t]=[t,e]),"function"!=typeof e&&(e=ExpressApp),"function"==typeof e&&("object"!=typeof t&&(t={}),e.use(((e,s,r)=>{engine(clean(e.url),{settings:{env:process.env.NODE_ENV||"development"},...t},((e,t)=>{!e&&t&&"string"==typeof t?s.status(200).send(t).end():r()}))})),e.use(((e,t)=>{let s=join(OPTS.root,"404."+OPTS.ext);fs.existsSync(s)?t.render(404):t.status(404).send("<h1>Error 404</h1><h2>Page Not Found</h2>").end()})))}module.exports=function(){const e=function(e={views:"views",components:"components",ext:"xhtml",template:void 0,cache:"2h",lazyCache:"12h",timeout:"30s",before:void 0,after:void 0,static:"/",opts:{}},t){return"function"!=typeof e&&"object"!=typeof t||([e,t]=[t,e]),function(e){let t=e.before,s=e.after,r=(e=clean(e)).views||"views";OPTS.ext=(e.ext||"xhtml").replace(/[^\w_\-]/g,"");let n=r.replace(/[^\w_\-\\\/\.@$#!]/g,"");if(n.startsWith(ROOT)||(n=join(ROOT,n)),OPTS.root=n,e.components){let t=e.components.replace(/[^\w_\-\\\/\.@$#!]/g,"");t.startsWith(ROOT)||(t=join(ROOT,t)),OPTS.components=t,localCache.watch([n,t])}else localCache.watch([n]);let a=(e.template||"").replace(/[^\w_\-\\\/\.@$#!]/g,"");a&&""!==a.trim()&&(OPTS.template=a),OPTS.cache=e.cache||"2h",OPTS.lazyCache=e.lazyCache||"12h",OPTS.timeout=e.timeout||"30s","function"==typeof t&&(OPTS.before=t),"function"==typeof s&&(OPTS.after=s),"string"==typeof e.static?OPTS.static=e.static:OPTS.static="/","object"==typeof e.opts?OPTS.opts=e.opts:OPTS.opts={},void 0!==e.secure?OPTS.secure=e.secure:OPTS.secure=!0}("object"==typeof e?e:{}),"function"==typeof t&&(function(e){e.use("/lazyload/:component/:id",(async(e,t,s)=>{let r="template_lazyload_cache:"+clean(e.params.component)+clean(e.params.id),n=localCache.get(r),a=toTimeMillis(OPTS.timeout||"30s")/100;for(;!n&&a-- >0;)await sleep(100),n=localCache.get(r);n?"string"==typeof n?(t.status(200).send(n).end(),localCache.delete(r)):(t.status(404).send("<h1>Error 404</h1><h2>Component Not Found</h2>").end(),localCache.delete(r)):getTemplateFile(clean(e.params.component),{},(async e=>{const s=await compile(e,{});"string"==typeof s?t.status(200).send(s).end():t.status(404).send("<h1>Error 404</h1><h2>Component Not Found</h2>").end()}))})),e.use("/lazyloadpage/:id/:page",(async(e,t,s)=>{let r=Number(clean(e.params.page));if(!r&&0!==r)return void t.status(400).send("<h1>Error 400</h1><h2>Page (last url param) Must Be A Valid Number</h2>").end();let n="template_lazyload_page_cache:"+clean(e.params.id),a=localCache.get(n),i=toTimeMillis(OPTS.timeout||"30s")/100;for(;!a&&i-- >0;)await sleep(100),a=localCache.get(n);a?Array.isArray(a)?(t.status(200).send(a[r]).end(),localCache.delete(n)):(t.status(404).send("<h1>Error 404</h1><h2>Component Not Found</h2>").end(),localCache.delete(n)):t.status(404).send("<h1>Error 404</h1><h2>Component Not Found</h2>").end()}))}(t),ExpressApp=t),engine};return e.renderPages=expressFallbackPages,e.function={...common,add:addTagFunction,run:runTagFunction},e}();