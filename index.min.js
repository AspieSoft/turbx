const eCommonFunc=function(){const e=require("crypto"),t=require("validator");function r(e){return Array.isArray(e)?"array":null===e?"null":e instanceof RegExp?"regex":typeof e}function n(e){return"number"==typeof e?e:Number(e.replace(/[^0-9.]/g,"").split(".",2).join("."))}return{escapeHTML:function(e){return e.replace(/[<>&]/g,(e=>{switch(e){case"<":return"&lt;";case">":return"&gt;";case"&":return"&amp;";default:return""}})).replace(/&amp;(amp;)*/g,"&amp;")},escapeHTMLArgs:function(e){return e.replace(/([\\"'`])/g,"\\$1")},compileMD:function(e){return e},compileJS:function(e){return e},compileCSS:function(e){return e},sleep:e=>new Promise((t=>setTimeout(t,e))),randomToken:function(t){return e.randomBytes(t).toString("hex")},clean:function(e,n=!1){let s=[338,339,352,353,376,402,8211,8212,8216,8217,8218,8220,8221,8222,8224,8225,8226,8230,8240,8364,8482];function i(e){if(e=t.stripLow(e,{keep_new_lines:!0}),t.isAscii(e))return e;let r="";for(let t=0;t<e.length;t++){let i=e.charCodeAt(t);(n&&i>=0&&i<=31||i>=32&&i<=127||i>=160&&i<=255||s.includes(i))&&(r+=e.charAt(t))}return t.isAscii(r)?r:void 0}return function e(t){if(null===t)return null;if(void 0!==t){if(NaN===t)return NaN;switch(r(t)){case"string":return i(t);case"array":return function(t){let r=[];return t.forEach((t=>{r.push(e(t))})),r}(t);case"object":return function(t){let r={};return Object.keys(t).forEach((n=>{n=e(n),r[n]=e(t[n])})),r}(t);case"number":return Number(t);case"boolean":return!!t;case"regex":let r="",n=t.toString().replace(/^\/(.*)\/(\w*)$/,(function(e,t,n){return r=i(n)||"",i(t)||""}));if(!n||""===n)return;return RegExp(n,r);case"symbol":return void 0!==(t=i(t.toString()))?Symbol(t):void 0;case"bigint":return BigInt(t.toString().replace(/[^0-9\.\-\+enf_]/g,""));default:return}}}(e)},varType:r,toTimeMillis:function(e){return"number"==typeof e?Number(e):e&&"string"==typeof e&&""!==e.trim()?e.endsWith("h")?36e5*n(e):e.endsWith("m")?6e4*n(e):e.endsWith("s")?1e3*n(e):e.endsWith("D")?864e5*n(e):e.endsWith("M")?2628e6*n(e):e.endsWith("Y")?31536e6*n(e):e.endsWith("DE")?31536e7*n(e):e.endsWith("C")||this.endsWith("CE")?31536e8*n(e):e.endsWith("ms")?n(e):e.endsWith("us")||this.endsWith("mic")?.001*n(e):e.endsWith("ns")?1e-6*n(e):n(e):NaN},toNumber:n,asyncReplace:async function(e,t,r,global){if(void 0===global&&(global=!!t.toString().match(/\/[\w]*g[\w]*$/)),!global){const n=e.match(t);return n?e.substring(0,n.index)+await r(...n,n.index)+e.substring(n.index+n[0].length):e}const n=[...e.matchAll(t)];if(n&&n.length){const t=[];for(let e=0;e<n.length;e++)t.push({start:n[e].index,end:n[e].index+n[e][0].length,res:await r(...n[e],n[e].index)});for(let r=t.length-1;r>=0;r--)e=e.substring(0,t[r].start)+t[r].res+e.substring(t[r].end)}return e},getOpt:function e(t,r,n=!0){if(["number","boolean"].includes(typeof r)&&(r=r.toString()),"string"!=typeof r||"object"!=typeof t)return"";r=r.split("|").map((e=>e.trim()));for(let s=0;s<r.length;s++){let i=r[s].split(/\.|(\[.*?\])/).filter((e=>"string"==typeof e&&""!==e.trim())).reduce(((r,n)=>"object"!=typeof r||r instanceof RegExp?r:(n.match(/^\[.*?\]$/)&&(n=(n=n.replace(/^\[(.*)\]$/,"$1")).match(/^(['"`])(.*)\1$/)?n.replace(/^(['"`])(.*)\1$/,"$2"):e(t,n)),n.match(/^(['"`])(.*)\1$/)?n.replace(/^(['"`])(.*)\1$/,"$2"):r[n])),t);if(!n){if(null==i){if(s===r.length-1)return i;continue}return i}if(null!=i&&"object"!=typeof i)return i.toString()}return""}}}(),eListFunc=["each","if","import","json","lazy","lorem"],eFunc={each:function({runFunc:e,getOpt:t}){return{name:"each",func:function(e,r,n,s,i){const a=Object.keys(e);if(!a.length)return"";let o,c,l,u=0;for(let t=1;t<a.length;t++)"as"===e[a[t]]?u=1:"of"===e[a[t]]?u=2:"in"===e[a[t]]?u=3:1===u?(o=e[a[t]],u=0):2===u?(c=e[a[t]],u=0):3===u?(l=e[a[t]],u=0):o?c?l||(l=e[a[t]]):c=e[a[t]]:o=e[a[t]];1===u?o=e[a[a.length-1]]:2===u?c=e[a[a.length-1]]:3===u&&(l=e[a[a.length-1]]);let p=t(n,e[0],!1);const m=[];if(Array.isArray(p))for(let t=0;t<p.length;t++){let s={...n};o?s[o]=p[t]:s[e[0]]=p[t],c&&(s[c]=t),l&&(s[l]=t),m.push({html:r,opts:s})}else if("object"==typeof p){const t=Object.keys(p);for(let s=0;s<t.length;s++){let i={...n};o?i[o]=p[t[s]]:i[e[0]]=p[t[s]],c&&(i[c]=t[s]),l&&(i[l]=s),m.push({html:r,opts:i})}}return m}}},if:function({runFunc:e,getOpt:t}){return{name:"if",func:function(r,n,s,i,a,o=!1){let c,l=o;if(!r.length)return n;for(let e=0;e<r.length;e++){if("&"===r[e]){if(l)continue;break}if("|"===r[e]){if(l)break;continue}let n,i,a;if(r[e+1]&&r[e+1].match(/^[!<>]?=|[<>]$/))n=r[e],i=r[e+1],a=r[e+2],c=n;else{if(!r[e].match(/^[!<>]?=|[<>]$/)||!r[e+1]){if(1===r.length){let i=!0;r[e].startsWith("!")&&(i=!1),"!"===r[e]?(n=r[e+1],e++):"!!"===r[e]?(n=r[e+1],e++,i=!0):n=r[e].replace("!",""),n.startsWith("!")&&(i=!i,n=n.replace("!","")),c=n,n.match(/^["'`].*["'`]$/)?(n=n.replace(/^["'`](.*)["'`]$/,"$1"),Number.isNaN(Number(n))||(n=Number(n))):n=n.match(/^-?[0-9]+(\.[0-9]+|)$/)?Number(n):t(s,n,!1),l=!n&&0!==n||""===n||Array.isArray(n)&&!n.length||"object"==typeof n&&!Object.keys(n).length,i&&(l=!l);continue}continue}n=c,i=r[e],a=r[e+1],e++}switch(n.match(/^["'`].*["'`]$/)?(n=n.replace(/^["'`](.*)["'`]$/,"$1"),Number.isNaN(Number(n))||(n=Number(n))):n.match(/^-?[0-9]+(\.[0-9]+|)$/)?n=Number(n):(n=t(s,n,!1),"string"==typeof n&&n.match(/^-?[0-9]+(\.[0-9]+|)$/)&&(n=Number(n))),a?a.match(/^["'`].*["'`]$/)?(a=a.replace(/^["'`](.*)["'`]$/,"$1"),Number.isNaN(Number(a))||(a=Number(a))):a.match(/^-?[0-9]+(\.[0-9]+|)$/)?a=Number(a):(a=t(s,a,!1),"string"==typeof a&&a.match(/^-?[0-9]+(\.[0-9]+|)$/)&&(a=Number(a))):a=void 0,c=n,i){case"=":l=n===a;break;case"!=":case"!":l=n!==a;break;case">=":l=n>=a;break;case"<=":l=n<=a;break;case">":l=n>a;break;case"<":l=n<a}e+=2}let u=n.match(new RegExp(`<_el(if|se):${i}(\\s+[0-9]+|)/>`));return u&&l?n.substring(0,u.index):u?e("if",a.args[u[2].trim()],n.substring(u.index+u[0].length),s,i,a,"se"===u[1]):l?n:""}}},import:function({runFunc:e,getOpt:t}){return{name:"import",func:function(e,t,r,n,s){return""}}},json:function({runFunc:e,getOpt:t}){return{name:"json",func:function(e,r,n,s,i){let a=t(n,e[0],!1),o=Number(e[1])||0;return a=o?JSON.stringify(a,null,o):JSON.stringify(a),"string"!=typeof a?"":("true"!==e[1]&&"true"!==e[2]||(a=a.replace(/(,\s*|)\s?"([\w_-])":/g,"$1 $2:").replace(/^{\s/,"{")),a)}}},lazy:function({runFunc:e,getOpt:t}){return{name:"lazy",func:function(e,t,r,n,s){return""}}}};eFunc.lorem=function(){const{LoremIpsum:e}=require("lorem-ipsum"),t=new e({sentencesPerParagraph:{max:8,min:4},wordsPerSentence:{max:16,min:4}});return function({runFunc:e,getOpt:r}){return{name:["lorem","ipsum","lorem-ipsum","text"],func:function(e,n,s,i,a){let o=e[0],c=e[1];o&&(o=o.replace(/^(["'`])(.*)\1$/,"")),c&&(c=c.replace(/^(["'`])(.*)\1$/,""));let l=0;return"string"==typeof o&&o.match(/^w(ords?|)$/i)?(l=1,o=c):"string"==typeof c&&c.match(/^w(ords?|)$/i)?l=1:"string"==typeof o&&o.match(/^s(ent(ences?|)|)$/i)?(l=2,o=c):"string"==typeof c&&c.match(/^s(ent(ences?|)|)$/i)&&(l=2),"string"==typeof o&&o.match(/([0-9]+)/)?o=Number(o):o&&(o=Number(r(s,o))),0===o?"":(o||(o=1),1===l?t.generateWords(o):2===l?t.generateSentences(o):t.generateParagraphs(o))},"lorem-p":function(e,n,s,i,a){let o=e[0];return o&&(o=o.replace(/^(["'`])(.*)\1$/,"")),"string"==typeof o&&o.match(/([0-9]+)/)?o=Number(o):o&&(o=Number(r(s,o))),0===o?"":(o||(o=1),t.generateParagraphs(o))},p:"lorem-p",paragraph:"lorem-p","lorem-s":function(e,n,s,i,a){let o=e[0];return o&&(o=o.replace(/^(["'`])(.*)\1$/,"")),"string"==typeof o&&o.match(/([0-9]+)/)?o=Number(o):o&&(o=Number(r(s,o))),0===o?"":(o||(o=1),t.generateSentences(o))},s:"lorem-s",sentence:"lorem-s","lorem-w":function(e,n,s,i,a){let o=e[0];return o&&(o=o.replace(/^(["'`])(.*)\1$/,"")),"string"==typeof o&&o.match(/([0-9]+)/)?o=Number(o):o&&(o=Number(r(s,o))),0===o?"":(o||(o=1),t.generateWords(o))},w:"lorem-w",word:"lorem-w"}}}();const eRunFunc=function(){require("fs");const{join:e}=require("path"),t={};function r(e,r){if(Array.isArray(e)||(e=[e]),(e=e.filter((e=>"string"==typeof e&&!t[e])).map((e=>e.toLowerCase().replace(/[-_]/g,"")))).length){Array.isArray(r)?r=r.filter((e=>["string","function"].includes(typeof e))).map((e=>"string"==typeof e?e.toLowerCase().replace(/[-_]/g,""):e)):"string"==typeof r&&(r=r.toLowerCase().replace(/[-_]/g,"")),t[e[0]]=r;for(let r=1;r<e.length;r++)"string"!=typeof e[r]||t[e[r]]||(t[e[r]]=e[0])}}function n(e){e=e.toLowerCase().replace(/[-_]/g,"");let r=t[e];if("string"==typeof r&&(r=t[r]),"function"==typeof r){let e=[...arguments];return e.shift(),r(...e)}return""}const s={...eCommonFunc,runFunc:n};return(e=>{for(let t=0;t<e.length;t++){let n=eFunc[e[t]];if("function"==typeof n&&(n=n(s)),"object"!=typeof n)return;let i=Object.keys(n);for(let e=0;e<i.length;e++)"name"!==i[e]&&"func"!==i[e]&&"function"!==i[e]&&r(i[e],n[i[e]]);if(n.name||(n.name=e[t].replace(/\.[^\.]+$/,"")),!n.func&&n.function)n.func=n.function;else if(!n.func)return;r(n.name,n.func)}})(eListFunc),{tagFunctions:t,addTagFunction:r,runTagFunction:n}}(),fs=require("fs"),{join}=require("path"),crypto=require("crypto"),memoryCache=require("@aspiesoft/obj-memory-cache"),multiTaskQueue=require("@aspiesoft/multi-task-queue"),device=(requireOptional("body-parser"),requireOptional("express-device"));function requireOptional(e){try{return require(e)}catch(e){return}}const common=eCommonFunc,{escapeHTML,escapeHTMLArgs,compileMD,compileJS,compileCSS,sleep,randomToken,clean,toTimeMillis,asyncReplace,getOpt}=common,{tagFunctions,addTagFunction,runTagFunction}=eRunFunc,localCache=memoryCache.newCache({watch:__dirname}),taskQueue=multiTaskQueue(10);let ExpressApp;const ROOT=require.main.filename?clean(require.main.filename.toString()).replace(/[\\\/][^\\\/]+[\\\/]?$/,""):require.main.path?clean(require.main.path.toString()):process.cwd&&process.cwd()?clean(process.cwd()):clean(join(__dirname).toString().replace(/[\/\\]node_modules[\/\\][^\\\/]+[\\\/]?$/,"")),OPTS={},emptyRes=JSON.stringify({html:"",scripts:[],args:[]});function getTemplateFile(e,t,r,n=!1){const s=t.components||OPTS.components||void 0;taskQueue(e,(async i=>{if(n&&s){const t=localCache.get("template_component_cache:"+e);if(t||""===t)return i(),void r(t)}const a=localCache.get("template_file_cache:"+e);if(a||""===a)return i(),void r(a);let o;return n&&s&&(o=join(s,e+"."+OPTS.ext),o===OPTS.root||!o.startsWith(OPTS.root))?(localCache.set("template_component_cache:"+e,"",{expire:t.cache||OPTS.cache||"2h"}),i(),void r(emptyRes)):(o&&fs.existsSync(o)||(o=join(OPTS.root,e+"."+OPTS.ext),o!==OPTS.root&&o.startsWith(OPTS.root)))&&(o&&fs.existsSync(o)||(o=join(OPTS.root,e,"index."+OPTS.ext),o!==OPTS.root&&o.startsWith(OPTS.root)))&&o&&fs.existsSync(o)?void fs.readFile(o,((n,s)=>{if(n)return localCache.set("template_file_cache:"+e,"",{expire:t.cache||OPTS.cache||"2h",listen:[o]}),i(),void r(emptyRes);s=function(e){e=e.replace(/%!|!%/g,(e=>"%!"===e?"%!o!%":"!%"===e?"%!c!%":""));const t=[];function r(e,r){return e.replace(/%!([0-9]+)!%/g,((e,n)=>{if(!1===r)return t[n].str;if(!0===r){let e=t[n].str;return e.match(/^-?[0-9]+(\.[0-9]+|)$/)?e:t[n].tag+e+t[n].tag}return t[n].tag+t[n].str+t[n].tag})).replace(/%!([oc])!%/g,((e,t)=>"o"===t?"%!":"c"===t?"!%":""))}e=e.replace(/(['"`])((?:\\[\\'"`]|.)*?)\1|<!--.*?-->|\/\*.*?\*\/|(?<!:)(?:\/\/|#!).*?\r?\n/gs,((e,r,n)=>r&&n?`%!${t.push({tag:r,str:n})-1}!%`:""));const n=[];e=e.replace(/<(script|js|style|css|less|markdown|md|text|txt)(.*?)>(.*?)<\/\1>/gis,((e,s,i,a)=>{if("md"===(s=s.toLowerCase())?s="markdown":"txt"===s?s="text":"js"===s?s="script":"css"!==s&&"less"!==s||(s="style"),i=r(i),"script"===s){let e=[];return a=a.replace(/%!([0-9]+)!%/g,((r,n)=>`%!${e.push(t[n])-1}!%`)),a=compileJS(a),`<!_script ${n.push({tag:s,args:i,content:a,strings:e})-1}/>`}return a=r(a),"text"===s?a=escapeHTML(a):"markdown"===s?a=compileMD(a):"script"===s?a=compileJS(a):"style"===s&&(a=compileCSS(a)),`<!_script ${n.push({tag:s,args:i,content:a})-1}/>`}));const s=[];let i=0;return e=e.replace(/<(\/|)([\w_\-\.$!:]+)\s*(.*?)\s*(\/|)>/gs,((e,t,n,a,o)=>{if(a=a.split(/\s+/),!n.match(/^_|[A-Z]/))return""!==(a=r(a=a.sort(((e,t)=>{if("string"!=typeof e||"string"!=typeof t)return 0;let r=e.substring(0,e.indexOf("=")),n=t.substring(0,t.indexOf("="));return r>n?1:r<n?-1:0})).join(" "))).trim()&&(a=" "+a),`<${t}${n}${a}${o}>`;if(""===t){let e;if(n.match(/^_(el(if|se)|if)$/)){e=[];for(let t=0;t<a.length;t++){if(a[t].match(/^([!<>]?=|{{{?.*?}}}?)$/)){e.push(a[t]);continue}let n=a[t].split(/([!<>]?=|[&|<>])/);e.push(...n.map((e=>r(e,!0))).filter((e=>e&&""!==e.trim())))}e.map((e=>e.match(/^(["'`])[0-9]+(?:\.[0-9]+|)\1$/)?Number(e.replace(/^(["'`])([0-9]+(?:\.[0-9]+|))\1$/,"$2")):e))}else{e={};let t=0;for(let n=0;n<a.length;n++){if(""===a[n])continue;if(a[n]&&"="===a[n+1]&&a[n+2]){e[r(a[n],!1)]=r(a[n+2],!0),n+=2;continue}let s=a[n].split("=");if(1===s.length)e[t]=r(s[0],!0),t++;else if(2===s.length)e[r(s[0],!1)]=r(s[1],!0);else if(s.length>2){let t=s[s.length-1];for(let n=0;n<s.length-1;n++)e[r(s[n],!1)]=r(s[t],!0)}}const n=Object.keys(e);for(let t=0;t<n.length;t++)e[n[t]].match(/^(["'`])[0-9]+(?:\.[0-9]+|)\1$/)&&(e[n[t]]=Number(e[n[t]].replace(/^(["'`])([0-9]+(?:\.[0-9]+|))\1$/,"$2")))}let t=`<${n}:${i} ${s.push(e)-1}${o}>`;return""===o&&i++,t}return i--,`</${n}:${i}>`})),a=e=r(e),e=a.replace(/%!([oc])!%/g,((e,t)=>"o"===t?"%!":"c"===t?"!%":"")),JSON.stringify({html:e,scripts:n,args:s,strings:t});var a}(s.toString()),localCache.set("template_file_cache:"+e,s,{expire:t.cache||OPTS.cache||"2h",listen:[o]}),i(),r(s)})):(localCache.set("template_file_cache:"+e,"",{expire:t.cache||OPTS.cache||"2h"}),i(),void r(emptyRes))}))}function engine(e,t,r){e=clean(e),t=clean(t),OPTS.ext||(OPTS.ext=t.settings["view engine"]||(e.includes(".")?e.substring(e.lastIndexOf(".")).replace(".",""):"xhtml")),OPTS.root||(OPTS.root=t.settings.views||t.settings.view||(require.main.filename||process.argv[1]||__dirname).replace(/([\\\/]node_modules[\\\/].*?|[\\\/][^\\\/]*)$/,"/views")),e.includes(".")&&(e=e.substring(0,e.lastIndexOf("."))),e=e.replace(OPTS.root,"").replace(/^[\\\/]+/,""),t.settings.filename=e,getTemplateFile(e,t,(async e=>{if(e===emptyRes)return r(new Error("View Not Found!"),"");if(OPTS.before){let r=OPTS.before(e,t);void 0!==r&&(e=r)}if("function"==typeof t.before){let r=t.before(e,t);void 0!==r&&(e=r)}if(e=await compile(e,t,!0),"function"==typeof t.after){let r=t.after(e,t);void 0!==r&&(e=r)}if(OPTS.after){let r=OPTS.after(e,t);void 0!==r&&(e=r)}return r(null,e)}))}async function compile(e,t,r=!1){if(OPTS.opts&&(t={...OPTS.opts,...t}),"string"==typeof e&&(e=JSON.parse(e)),r){let r=t.template||OPTS.template;if("string"==typeof r){let n=!1;for(getTemplateFile(r,t,(async r=>{""!==(r=await compile(r,t)).trim()?(r.match(/{{{?body}}}?|<body(\s+.*?|)\/>/is)?e.html=r.replace(/{{{?body}}}?|<body(\s+.*?|)\/>/is,e.html):r.match(/<(main|\/header)(\s+.*?|)>/is)?e.html=r.replace(/<(main|\/header)(\s+.*?|)>/is,(t=>t+"\n"+e.html)):r.match(/<(footer|\/body)(\s+.*?|)>/is)?e.html=r.replace(/<(footer|\/body)(\s+.*?|)>/is,(t=>e.html+"\n"+t)):e.html=r+e.html,n=!0):n=!0}));!n;)await sleep(10)}}return await runFunctions(e,t),r&&function(){let r;if(!1===function(e){let t=e.secure||OPTS.secure;if("object"!=typeof t)return!0;let r=Object.keys(t)[0];return"string"!=typeof r||!1!==t[r]||"7LUl6NM1epycs7tWgXC/FuPl2NDhUL59uFzT+1B9Fgg="!==crypto.createHash("sha256").update(r).digest("base64")}(t))r={...t},delete r.secure,delete r.settings,delete r._locals,delete r.cache,delete r.template,delete r.view,delete r.views;else{if(!t.public)return;r={...t.public}}const n=`<script>\n        ;const OPTS = ${JSON.stringify(r)};\n      <\/script>`;e.html.match(/<\/head>/)?e.html=e.html.replace(/<\/head>/,`\n        ${n}\n        </head>\n        `):e.html.match(/<body(\s+.*?|)>/)?e.html=e.html.replace(/<body(\s+.*?|)>/,`\n        <body$1>\n        ${n}\n        `):e.html.match(/<!_script(\s+.*?|)>/)?e.html=e.html.replace(/!_<script(\s+.*?|)>/,`\n        ${n}\n        <!_script$1>\n        `):e.html=n+e.html}(),e.html=e.html.replace(/<(\/|)([\w_\-\.$!:]+):[0-9]+\s+(.*?)(\/|)>/g,((t,r,n,s,i)=>{if(n.startsWith("_")||n.startsWith("!_"))return"";if(""===r){let t=[],r=e.args[s],a=Object.keys(r);for(let e=0;e<a.length;e++)Number(a[e])||0===Number(a[e])?t.push(r[a[e]]):t.push(a[e]+"="+r[a[e]]);if(!Array.isArray(t)){const e=Object.keys(t),r=[];for(let n=0;n<e.length;n++)r.push(e[n]+"="+t[e[n]]);t=r}t=t.sort(((e,t)=>{if("string"!=typeof e||"string"!=typeof t)return 0;let r=e.substring(0,e.indexOf("=")),n=t.substring(0,t.indexOf("="));return r>n?1:r<n?-1:0})).join(" "),""!==t.trim()&&(t=" "+t);let o=`<${n}${t}>`;return""!==i&&(o+=`</${n}>`),o}return`</${n}>`})),e.html=e.html.replace(/<!_script\s+([0-9]+)\/>/gs,((r,n)=>{let s=e.scripts[n],i=s.content;return"script"===s.tag&&(i=i.replace(/(?<![\w_$]+)OPTS\.((?:\[.*?\]|[\w_$\.])+)/g,((e,r)=>{let n=getOpt(t,r,!1);return n instanceof RegExp?n.toString():"object"==typeof n?JSON.stringify(n):"string"==typeof n?"'"+n.replace(/'/g,"\\'")+"'":void 0!==n?null===n?null:n.toString():void 0})).replace(/%!([0-9]+)!%/g,((e,t)=>s.strings[t].tag+s.strings[t].str+s.strings[t].tag)).replace(/%!([oc])!%/g,((e,t)=>"o"===t?"%!":"c"===t?"!%":""))),"script"===s.tag||"style"===s.tag?`<${s.tag}${s.args}>${i}</${s.tag}>`:`<div type="${s.tag}"${s.args}>${i}</div>`})),e.html}async function runFunctions(e,t,r=0){return e.html=await asyncReplace(e.html,new RegExp(`<_([\\w_\\-\\.$!:]+):${r}(\\s+[0-9]+|)>(.*?)</_\\1:${r}>`,"gs"),(async(n,s,i,a)=>{let o=e.args[i.trim()];s=s.toLowerCase().replace(/[-_]/g,"");const c=tagFunctions[s];if(!c)return"";if(Array.isArray(c)){let n;for(let s=0;s<c.length;s++){let i=c[s];"string"==typeof i&&(i=tagFunctions[i]),"function"==typeof i&&(n=await c(o,a,t,r+1,{scripts:e.scripts,args:e.args}))}if(["string","number","boolean"].includes(typeof n)&&!Number.isNaN(n))return await runFunctions({html:n.toString(),scripts:e.scripts,args:e.args},t,r+1);if(Array.isArray(n)){let t="";for(let s=0;s<n.length;s++)t+=await runFunctions({html:n[s].html.toString(),scripts:e.scripts,args:e.args},n[s].opts,r+1);return t}return""}if("string"==typeof c&&(c=tagFunctions[c]),"function"==typeof c){let n=await c(o,a,t,r+1,{scripts:e.scripts,args:e.args});if(["string","number","boolean"].includes(typeof n)&&!Number.isNaN(n))return await runFunctions({html:n.toString(),scripts:e.scripts,args:e.args},t,r+1);if(Array.isArray(n)){let t="";for(let s=0;s<n.length;s++)t+=await runFunctions({html:n[s].html.toString(),scripts:e.scripts,args:e.args},n[s].opts,r+1);return t}}return""})),e.html=await asyncReplace(e.html,new RegExp(`<([A-Z][\\w_\\-\\.$!:]+):${r}(\\s+[0-9]+|)>(.*?)</\\1:${r}>`,"gs"),(async(n,s,i,a)=>{let o,c=e.args[i.trim()];s=s.toLowerCase(),a=await runFunctions({html:a,scripts:e.scripts,args:e.args},t,r+1);const l={...t,...c,body:a};for(getTemplateFile(s,l,(async e=>{e=JSON.parse(e),o=await compile(e,l)}),!0);void 0===o;)await sleep(10);return o})),e.html=await asyncReplace(e.html,new RegExp(`<([A-Z][\\w_\\-\\.$!:]+):${r}(\\s+[0-9]+|)/>`,"gs"),(async(r,n,s)=>{let i,a=e.args[s.trim()];n=n.toLowerCase();const o={...t,...a};for(getTemplateFile(n,o,(async e=>{let t=await compile(e,o);i=t.replace(/<body\/>|{{{?body}}}?/is,"")}),!0);void 0===i;)await sleep(10);return i})),e.html=await asyncReplace(e.html,new RegExp(`<_([\\w_\\-\\.$!:]+):${r}(\\s+[0-9]+|)/>`,"gs"),(async(n,s,i)=>{let a=e.args[i.trim()];s=s.toLowerCase().replace(/[-_]/g,"");let o=tagFunctions[s];if(!o)return"";if(Array.isArray(o)){let n;for(let s=0;s<o.length;s++){let i=o[s];"string"==typeof i&&(i=tagFunctions[i]),"function"==typeof i&&(n=await o(a,null,t,r+1,{scripts:e.scripts,args:e.args}))}if(["string","number","boolean"].includes(typeof n)&&!Number.isNaN(n))return await runFunctions({html:n.toString(),scripts:e.scripts,args:e.args},t,r+1);if(Array.isArray(n)){let t="";for(let s=0;s<n.length;s++)t+=await runFunctions({html:n[s].html.toString(),scripts:e.scripts,args:e.args},n[s].opts,r+1);return t}return""}if("string"==typeof o&&(o=tagFunctions[o]),"function"==typeof o){let n=await o(a,null,t,r+1,{scripts:e.scripts,args:e.args});if(["string","number","boolean"].includes(typeof n)&&!Number.isNaN(n))return await runFunctions({html:n.toString(),scripts:e.scripts,args:e.args},t,r+1);if(Array.isArray(n)){let t="";for(let s=0;s<n.length;s++)t+=await runFunctions({html:n[s].html.toString(),scripts:e.scripts,args:e.args},n[s].opts,r+1);return t}}return""})),e.html=e.html.replace(/({{{?)(.*?)(}}}?)/gs,((e,r,n,s)=>{if(2===(n=n.split("=")).length){let e="",r=n[1].replace(/(["'`]|)(.*?)\1/gs,((t,r,n)=>(e=r,n))),s=getOpt(t,r);return""===n[0].trim()?(r=r.split("|")[0].split(/\.|(\[.*?\])/).filter((e=>e&&!e.match(/^[0-9]+|\[.*\]$/))),r=r[r.length-1],r+"="+e+escapeHTMLArgs(s)+e):n[0].trim()+"="+e+escapeHTMLArgs(s)+e}let i=getOpt(t,n[0].trim());return"{{"!==r&&"}}"!==s||(i=escapeHTML(i)),i})),e.html}function expressFallbackPages(e,t){"object"==typeof e&&([e,t]=[t,e]),"function"!=typeof e&&(e=ExpressApp),"function"==typeof e&&("object"!=typeof t&&(t={}),e.use(((e,r,n)=>{const s=clean(e.url).replace(/^[\\\/]+/,"").replace(/\?.*/,"");if(s===OPTS.template||s.match(/^(errors?\/|)[0-9]{3}$/))return void n();let i=join(OPTS.root,s+"."+OPTS.ext);if(i!==OPTS.root&&i.startsWith(OPTS.root)&&!i.startsWith(OPTS.components))if(fs.existsSync(i))try{r.render(s,t)}catch(e){n()}else n();else n()})),e.use(((e,r)=>{let n=join(OPTS.root,"error/404."+OPTS.ext);fs.existsSync(n)?r.status(404).render("error/404",t):(n=join(OPTS.root,"404."+OPTS.ext),fs.existsSync(n)?r.status(404).render("404",t):r.status(404).send("<h1>Error 404</h1><h2>Page Not Found</h2>").end())})))}function expressRateLimit(e,t,r,n,s){let i=0;for(let a=0;a<3;a++)"function"==typeof arguments[a]?e=arguments[a]:"object"==typeof arguments[a]?t=arguments[a]:"number"==typeof arguments[a]?r=arguments[a]:"string"==typeof arguments[a]&&(0===i?n=arguments[a]:1===i&&(s=arguments[a]),i++);if("function"!=typeof e&&(e=ExpressApp),"function"!=typeof e)return;"object"!=typeof t&&(t={}),"number"!=typeof r&&(r=100),"string"!=typeof n&&(n="1m"),"string"!=typeof s&&(s="1h"),r*=5;const a={},o={};function c(e,r,n){let s=join(OPTS.root,"error/"+r+"."+OPTS.ext);fs.existsSync(s)?e.status(r).render("error/"+r,t):(s=join(OPTS.root,r+"."+OPTS.ext),fs.existsSync(s)?e.status(r).render(r.toString(),t):e.status(r).send("<h1>Error "+r+"</h1><h2>"+n+"</h2>").end())}setInterval((()=>{let e=Object.keys(a);for(let t=0;t<e.length;t++)delete a[e[t]];e=Object.keys(o);for(let t=0;t<e.length;t++)(new Date).getTime()>o[e[t]]&&delete o[e[t]]}),toTimeMillis(n)),device&&e.use(device.capture()),e.use(((e,t,n)=>{const i=clean(e.ip);if("localhost"===i||"127.0.0.1"===i||"::1"===i)return void n();let l,u=5,p="other",m=e.header("User-Agent");if(m.match(/\blinux\b/i)?(p="linux",u+=3):m.match(/\bwindows\b/i)?p="windows":m.match(/\b(apple|mac)\b/i)?(p="apple",u+=1):m.match(/\bchrom(e|ium)\s*os\b/i)?(p="chrome",u-=1):m.match(/\bandroid\b/i)?(p="android",u-=2):m.match(/\bios\b/i)&&(p="ios",u-=3),device){let t=e.device.type;"other"!==p&&"bot"===t?u*=1.2:"phone"===t?u-=1:"tv"===t?u-=2:"car"===t&&(u-=3)}u<1&&(u=1),i.includes("::")?(l=i.replace(/^(.*?::.*?)::.*$/,"$1"),l+=":"+p,device&&(l+=":"+e.device.type+":"+e.device.name)):i.match(/^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$/)?(l=i.replace(/^([0-9]+\.[0-9]+\.[0-9]+)\.[0-9]+$/,"$1"),l+=":"+p,device&&(l+=":"+e.device.type),u+=1):(l=i,u+=2);try{a[l]||(a[l]=0),a[l]+=u}catch(e){}if(!((new Date).getTime()>o[l]))return a[l]>r?(o[l]=(new Date).getTime()+toTimeMillis(s),void c(t,429,"Too Many Requests")):void n();c(t,429,"Too Many Requests")}))}module.exports=function(){const e=function(e={views:"views",components:"components",ext:"xhtml",template:void 0,cache:"2h",lazyCache:"12h",timeout:"30s",before:void 0,after:void 0,static:"/",opts:{}},t){return"function"!=typeof e&&"object"!=typeof t||([e,t]=[t,e]),function(e){let t=e.before,r=e.after,n=(e=clean(e)).views||e.view||"views";OPTS.ext=(e.ext||"xhtml").replace(/[^\w_\-]/g,"");let s=n.replace(/[^\w_\-\\\/\.@$#!]/g,"");s.startsWith(ROOT)||(s=join(ROOT,s)),OPTS.root=s;let i=e.components||e.component||"components";if(i){let e=i.replace(/[^\w_\-\\\/\.@$#!]/g,"");e.startsWith(ROOT)||(e=join(OPTS.root,e)),OPTS.components=e,localCache.watch([s,e])}else localCache.watch([s]);let a=(e.template||"").replace(/[^\w_\-\\\/\.@$#!]/g,"");a&&""!==a.trim()&&(OPTS.template=a),OPTS.cache=e.cache||"2h",OPTS.lazyCache=e.lazyCache||"12h",OPTS.timeout=e.timeout||"30s","function"==typeof t&&(OPTS.before=t),"function"==typeof r&&(OPTS.after=r),"string"==typeof e.static?OPTS.static=e.static:OPTS.static="/","object"==typeof e.opts?OPTS.opts=e.opts:OPTS.opts={},void 0!==e.secure?OPTS.secure=e.secure:OPTS.secure=!0}("object"==typeof e?e:{}),"function"==typeof t&&(function(e){e.use("/lazyload/:component/:id",(async(e,t,r)=>{let n="template_lazyload_cache:"+clean(e.params.component)+clean(e.params.id),s=localCache.get(n),i=toTimeMillis(OPTS.timeout||"30s")/100;for(;!s&&i-- >0;)await sleep(100),s=localCache.get(n);s?"string"==typeof s?(t.status(200).send(s).end(),localCache.delete(n)):(t.status(404).send("<h1>Error 404</h1><h2>Component Not Found</h2>").end(),localCache.delete(n)):getTemplateFile(clean(e.params.component),{},(async e=>{const r=await compile(e,{});"string"==typeof r?t.status(200).send(r).end():t.status(404).send("<h1>Error 404</h1><h2>Component Not Found</h2>").end()}))})),e.use("/lazyloadpage/:id/:page",(async(e,t,r)=>{let n=Number(clean(e.params.page));if(!n&&0!==n)return void t.status(400).send("<h1>Error 400</h1><h2>Page (last url param) Must Be A Valid Number</h2>").end();let s="template_lazyload_page_cache:"+clean(e.params.id),i=localCache.get(s),a=toTimeMillis(OPTS.timeout||"30s")/100;for(;!i&&a-- >0;)await sleep(100),i=localCache.get(s);i?Array.isArray(i)?(t.status(200).send(i[n]).end(),localCache.delete(s)):(t.status(404).send("<h1>Error 404</h1><h2>Component Not Found</h2>").end(),localCache.delete(s)):t.status(404).send("<h1>Error 404</h1><h2>Component Not Found</h2>").end()}))}(t),ExpressApp=t),engine};return e.renderPages=expressFallbackPages,e.rateLimit=expressRateLimit,e.function={...common,add:addTagFunction,run:runTagFunction},e}();